<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h4 mb-0">
        <% if defined?(@forum) && @forum.present? %>
          フォーラム: <%= h(@forum.title) %> のトピック一覧
        <% else %>
          トピック一覧
        <% end %>
      </h2>
      <div class="text-muted">
        <% if defined?(@forum) && @forum.present? %>
          フォーラムID: <%= @forum.id %> ・ トピック数: <%= @topics.size %>
        <% else %>
          サイト内の全トピックを管理します
        <% end %>
      </div>
    </div>

    <div>
      <% if defined?(@forum) && @forum.present? %>
        <%= link_to 'フォーラム一覧へ戻る', admin_forums_path, class: 'btn btn-outline-secondary me-2' %>
      <% end %>
      <%= link_to '管理ダッシュボードへ', admin_root_path, class: 'btn btn-outline-secondary' %>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <!-- 並び替え -->
      <div class="mb-2">
        <% sort_params = { id: 'ID順', title: 'タイトル順', creator_id: '作成者順', posts_count: '投稿数順', created_at: '作成日順' } %>
        <% sort_params.each do |key, label| %>
          <% selected = (params[:sort] == key.to_s) %>
          <% direction = selected ? (params[:direction] == 'asc' ? 'desc' : 'asc') : 'desc' %>
          <%= link_to "#{label}#{selected ? (params[:direction] == 'asc' ? '↑' : '↓') : ''}", url_for(params.to_unsafe_h.merge(sort: key, direction: direction, page: nil)), class: (selected ? "fw-bold text-primary" : "") %>
          <% unless key == :created_at %>｜<% end %>
        <% end %>
      </div>

      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>タイトル</th>
              <th>フォーラム</th>
              <th>作成者</th>
              <th>投稿数</th>
              <th>状態</th>
              <th>作成日</th>
              <th class="text-end">操作</th>
            </tr>
          </thead>

          <tbody>
            <% @topics.each do |topic| %>
              <tr>
                <td><%= topic.id %></td>
                <td style="max-width: 360px;">
                  <%= link_to truncate(topic.title, length: 80), admin_topic_path(topic), class: 'text-decoration-none' %>
                  <% if topic.description.present? %>
                    <div class="text-muted small mt-1"><%= truncate(topic.description, length: 120) %></div>
                  <% end %>
                </td>
                <td>
                  <% if topic.forum.present? %>
                    <%= link_to topic.forum.title, admin_forums_path(anchor: "forum-#{topic.forum.id}"), class: 'text-decoration-none' %>
                  <% else %>
                    <span class="text-muted">なし</span>
                  <% end %>
                </td>
                <td>
                  <% if topic.creator.present? %>
                    <% name = topic.creator.respond_to?(:nickname) ? h(topic.creator.nickname) : "User##{topic.creator_id}" %>
                    <%# 管理画面のユーザー詳細 (admin_user_path) が存在すればそちらへ、なければ通常のユーザー詳細へフォールバックします %>
                    <% begin %>
                      <%= link_to name, [:admin, topic.creator], class: 'text-decoration-none' %>
                    <% rescue ActionController::UrlGenerationError, NameError %>
                      <%= link_to name, topic.creator, class: 'text-decoration-none' %>
                    <% end %>
                  <% else %>
                    <span class="text-muted">User#<%= topic.creator_id %></span>
                  <% end %>
                </td>
                <td><%= topic.posts_count %></td>
                <td>
                  <% if topic.locked? %>
                    <span class="badge bg-danger">ロック</span>
                  <% else %>
                    <span class="badge bg-success">公開</span>
                  <% end %>
                </td>
                <td><%= l(topic.created_at, format: :short) rescue topic.created_at.to_s %></td>
                <td class="text-end">

                  <%# ロック or アンロック切替ボタン（PATCHで update を利用） %>
                  <% if topic.locked? %>
                    <%= button_to 'ロック解除', admin_topic_path(topic),
                          method: :patch,
                          params: { topic: { locked: false } },
                          class: 'btn btn-sm btn-outline-success me-2',
                          data: { confirm: 'このトピックのロックを解除しますか？' } %>
                  <% else %>
                    <%= button_to 'ロックする', admin_topic_path(topic),
                          method: :patch,
                          params: { topic: { locked: true } },
                          class: 'btn btn-sm btn-outline-warning me-2',
                          data: { confirm: 'このトピックをロック（投稿禁止）にしますか？' } %>
                  <% end %>

                  <%= link_to '表示', admin_topic_path(topic), class: 'btn btn-sm btn-outline-primary me-2' %>
                  <%= link_to '削除', admin_topic_path(topic), method: :delete,
                        data: { confirm: 'このトピックを削除しますか？' },
                        class: 'btn btn-sm btn-danger' %>
                </td>
              </tr>
            <% end %>

            <% if @topics.empty? %>
              <tr>
                <td colspan="9" class="text-center text-muted py-4">トピックが見つかりません。</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-center mt-3">
    <!-- 下部ページネーション -->
    <%= paginate @topics, theme: 'bootstrap4' %>
  </div>
</div>