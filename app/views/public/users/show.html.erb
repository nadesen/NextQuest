<div class="py-5">
  <div class="container">
    <% display_name = (@user.nickname.presence || @user.name || 'ユーザー') %>
    <div class="row">
      <!-- 投稿一覧 -->
      <div class="col-md-8">
        <div class="mb-4">
          <h4 class="h6 mb-3"><%= "#{h(display_name)}さんの投稿" %></h4>
          <!-- トピック一覧 -->
          <div class="card mb-3">
            <div class="card-header">
              <%# ページネーション対応の「全件数」を表示（Kaminari / WillPaginate / fallback） %>
              <% topics_total =
                   if defined?(@topics) && @topics.respond_to?(:total_count)
                     @topics.total_count
                   elsif defined?(@topics) && @topics.respond_to?(:total_entries)
                     @topics.total_entries
                   else
                     @topics.size
                   end %>
              トピック（全 <%= topics_total %> 件）
            </div>
            <div class="card-body p-0">
              <% if @topics.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>タイトル</th>
                        <th class="d-none d-md-table-cell">フォーラム</th>
                        <th class="text-end"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @topics.each do |topic| %>
                        <tr>
                          <td class="text-nowrap">
                            <% if topic.created_at %>
                              <%= topic.created_at.in_time_zone(Time.zone).strftime('%Y/%m/%d') %>
                              <br>
                              <small class="text-white"><%= topic.created_at.in_time_zone(Time.zone).strftime('%H:%M') %></small>
                            <% else %>
                              —
                            <% end %>
                          </td>
                          <td><%= h(topic.title) %></td>
                          <td class="d-none d-md-table-cell"><%= h(topic.try(:forum).try(:title) || '—') %></td>
                          <td class="text-end text-nowrap">
                            <% target_path = topic.respond_to?(:forum) && topic.forum.present? ? forum_topic_path(topic.forum, topic) : (defined?(topic_path) ? topic_path(topic) : '#') rescue '#' %>
                            <%= link_to '表示', target_path,
                                        class: 'btn btn-sm btn-outline-primary',
                                        aria: { label: "#{topic.title} のトピックを表示" } %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-center mt-2">
                  <%= paginate @topics, theme: 'bootstrap4', param_name: 'topics_page' %>
                </div>
              <% else %>
                <div class="p-3 text-muted"><%= "#{h(display_name)}さんはまだトピックの投稿はありません。" %></div>
              <% end %>
            </div>
          </div>

          <!-- ポスト一覧 -->
          <div class="card mb-3">
            <% posts_total =
                 if defined?(@posts) && @posts.respond_to?(:total_count)
                   @posts.total_count
                 elsif defined?(@posts) && @posts.respond_to?(:total_entries)
                   @posts.total_entries
                 else
                   @posts.size
                 end %>
            <div class="card-header">投稿（Post）（全 <%= posts_total %> 件）</div>
            <div class="card-body p-0">
              <% if @posts.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>内容</th>
                        <th class="d-none d-md-table-cell">トピック</th>
                        <th class="text-end"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @posts.each do |post| %>
                        <tr>
                          <td class="text-nowrap">
                            <% if post.created_at %>
                              <%= post.created_at.in_time_zone(Time.zone).strftime('%Y/%m/%d') %>
                              <br>
                              <small class="text-white"><%= post.created_at.in_time_zone(Time.zone).strftime('%H:%M') %></small>
                            <% else %>
                              —
                            <% end %>
                          </td>
                          <td><%= h(truncate(post.content.to_s, length: 80)) %></td>
                          <td class="d-none d-md-table-cell"><%= h(post.try(:topic).try(:title) || '—') %></td>
                          <td class="text-end text-nowrap">
                            <% if post.respond_to?(:topic) && post.topic.present? %>
                              <% target_path = post.topic.respond_to?(:forum) && post.topic.forum.present? ? forum_topic_path(post.topic.forum, post.topic) : (defined?(topic_path) ? topic_path(post.topic) : '#') rescue '#' %>
                              <%= link_to '表示', target_path,
                                          class: 'btn btn-sm btn-outline-primary',
                                          aria: { label: "投稿のあるトピックを表示" } %>
                            <% else %>
                              <span class="text-muted">—</span>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-center mt-2">
                  <%= paginate @posts, theme: 'bootstrap4', param_name: 'posts_page' %>
                </div>
              <% else %>
                <div class="p-3 text-muted"><%= "#{h(display_name)}さんはまだ投稿はありません。" %></div>
              <% end %>
            </div>
          </div>

          <!-- レビュー一覧 -->
          <div class="card mb-3">
            <% reviews_total =
                 if defined?(@reviews) && @reviews.respond_to?(:total_count)
                   @reviews.total_count
                 elsif defined?(@reviews) && @reviews.respond_to?(:total_entries)
                   @reviews.total_entries
                 else
                   @reviews.size
                 end %>
            <div class="card-header">レビュー（全 <%= reviews_total %> 件）</div>
            <div class="card-body p-0">
              <% if @reviews.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>プラットフォーム</th>
                        <th>ジャンル</th>
                        <th>タイトル</th>
                        <th class="text-nowrap">プレイ時間</th>
                        <th class="text-end"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @reviews.each do |review| %>
                        <tr>
                          <td class="text-nowrap">
                            <% if review.created_at %>
                              <%= review.created_at.in_time_zone(Time.zone).strftime('%Y/%m/%d') %>
                              <br>
                              <small class="text-white"><%= review.created_at.in_time_zone(Time.zone).strftime('%H:%M') %></small>
                            <% else %>
                              —
                            <% end %>
                          </td>
                          <td><%= h(review.platform&.name.presence || '—') %></td>
                          <td><%= h(review.genre&.name.presence || '—') %></td>
                          <td><%= h(review.title) %></td>
                          <td class="text-nowrap"><%= h(review.play_time.presence || '—') %></td>
                          <td class="text-end text-nowrap">
                            <% review_path_target = (defined?(review_path) ? review_path(review) : '#') rescue '#' %>
                            <%= link_to '表示', review_path_target,
                                        class: 'btn btn-sm btn-outline-primary',
                                        aria: { label: "#{review.title} のレビューを表示" } %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-center mt-2">
                  <%= paginate @reviews, theme: 'bootstrap4', param_name: 'reviews_page' %>
                </div>
              <% else %>
                <div class="p-3 text-muted"><%= "#{h(display_name)}さんはまだレビューはありません。" %></div>
              <% end %>
            </div>
          </div>

          <!-- レビューへのコメント一覧（テーブル形式） -->
          <div class="card mb-3">
            <% rc_total =
                 if defined?(@review_comments) && @review_comments.respond_to?(:total_count)
                   @review_comments.total_count
                 elsif defined?(@review_comments) && @review_comments.respond_to?(:total_entries)
                   @review_comments.total_entries
                 else
                   @review_comments.size
                 end %>
            <div class="card-header">レビューへのコメント（全 <%= rc_total %> 件）</div>
            <div class="card-body p-0">
              <% if @review_comments.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>コメントしたレビュー</th>
                        <th>コメント内容</th>
                        <th class="text-end" style="width:120px;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @review_comments.each do |rc| %>
                        <tr>
                          <td class="text-nowrap">
                            <% if rc.created_at %>
                              <%= rc.created_at.in_time_zone(Time.zone).strftime('%Y/%m/%d') %>
                              <br>
                              <small class="text-white"><%= rc.created_at.in_time_zone(Time.zone).strftime('%H:%M') %></small>
                            <% else %>
                              —
                            <% end %>
                          </td>
                          <td>
                            <%= link_to h(rc.review.title), review_path(rc.review), class: 'text-decoration-none' %>
                            <div class="small text-muted">
                              <%= h(rc.review.platform&.name.presence || '未設定') %> /
                              <%= h(rc.review.genre&.name.presence || '未設定') %>
                            </div>
                          </td>
                          <td><%= h(truncate(rc.comment.to_s, length: 120)) %></td>
                          <td class="text-end text-nowrap">
                            <%= link_to '表示', review_path(rc.review), class: 'btn btn-sm btn-outline-primary', aria: { label: "#{rc.review.title} のレビューを表示" } %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-center mt-2">
                  <%= paginate @review_comments, theme: 'bootstrap4', param_name: 'review_comments_page' %>
                </div>
              <% else %>
                <div class="p-3 text-muted"><%= "#{h(display_name)}さんはレビューに対するコメントはまだありません。" %></div>
              <% end %>
            </div>
          </div>

        </div>

        <div class="mt-3">
          <%= link_to 'トップページへ', root_path, class: 'btn btn-link' %>
        </div>
      </div>

      <!-- ユーザー情報（右側に移動、部分テンプレート化） -->
      <div class="col-md-4">
        <%= render 'user_info', user: @user %>
      </div>
    </div>
  </div>
</div>