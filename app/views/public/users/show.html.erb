<div class="py-5">
  <div class="container">
    <div class="row">
      <!-- ユーザー情報 -->
      <div class="col-md-4">
        <div class="card mb-4 shadow-sm">
          <div class="card-body">
            <h3 class="h5 mb-2"><strong>ニックネーム:</strong><%= h(@user.nickname.presence || @user.name || 'ユーザー') %></h3>

            <div class="mt-3">
              <h6 class="small text-muted mb-1"><strong>プロフィール</strong></h6>
              <% if @user.respond_to?(:profile_text) && @user.profile_text.present? %>
                <p class="mb-0" style="white-space: pre-wrap;"><%= h(@user.profile_text) %></p>
              <% else %>
                <p class="mb-0 text-muted">
                  プロフィールを設定していません。興味のあるゲームジャンルや好きなプラットフォーム、自己紹介を入力してみましょう。
                </p>
              <% end %>
            </div>

            <div class="mt-4 d-grid gap-2">
              <% if user_signed_in? && current_user.id == @user.id %>
                <%= link_to '編集 (退会処理もこちら)', edit_user_path(@user), class: 'btn btn-outline-primary' %>
                <div class="d-flex gap-2 mt-2">
                  <%= link_to 'フォロー中', followings_user_path(@user), class: 'btn btn-outline-secondary' %>
                  <%= link_to 'フォロワー', followers_user_path(@user), class: 'btn btn-outline-secondary' %>
                </div>
              <% end %>

              <div class="mt-2">
                <%= link_to 'いいね一覧', likes_user_path(@user), class: 'btn btn-outline-secondary' %>
              </div>

              <%# 他のユーザーがこのページを見たときにフォロー/アンフォローボタンを表示 %>
              <div class="mt-2">
                <%= render 'public/follows/btn', user: @user %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 投稿一覧（以下は元の show のまま） -->
      <div class="col-md-8">
        <div class="mb-4">
          <h4 class="h6 mb-3">あなたの投稿</h4>
          <!-- トピック一覧 -->
          <div class="card mb-3">
            <div class="card-header">
              トピック（最近 <%= @topics.size %> 件）
            </div>
            <div class="card-body p-0">
              <% if @topics.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>タイトル</th>
                        <th class="d-none d-md-table-cell">フォーラム</th>
                        <th class="text-end"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @topics.each do |topic| %>
                        <tr>
                          <td class="text-nowrap"><%= topic.created_at.strftime('%Y/%m/%d') %></td>
                          <td><%= h(topic.title) %></td>
                          <td class="d-none d-md-table-cell"><%= h(topic.try(:forum).try(:title) || '—') %></td>
                          <td class="text-end text-nowrap">
                            <% target_path = topic.respond_to?(:forum) && topic.forum.present? ? forum_topic_path(topic.forum, topic) : (defined?(topic_path) ? topic_path(topic) : '#') rescue '#' %>
                            <%= link_to '表示', target_path,
                                        class: 'btn btn-sm btn-outline-primary',
                                        aria: { label: "#{topic.title} のトピックを表示" } %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% else %>
                <div class="p-3 text-muted">まだトピックの投稿はありません。</div>
              <% end %>
            </div>
          </div>

          <!-- ポスト一覧 -->
          <div class="card mb-3">
            <div class="card-header">投稿（Post）（最近 <%= @posts.size %> 件）</div>
            <div class="card-body p-0">
              <% if @posts.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>内容</th>
                        <th class="d-none d-md-table-cell">トピック</th>
                        <th class="text-end"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @posts.each do |post| %>
                        <tr>
                          <td class="text-nowrap"><%= post.created_at.strftime('%Y/%m/%d') %></td>
                          <td><%= h(truncate(post.content.to_s, length: 80)) %></td>
                          <td class="d-none d-md-table-cell"><%= h(post.try(:topic).try(:title) || '—') %></td>
                          <td class="text-end text-nowrap">
                            <% if post.respond_to?(:topic) && post.topic.present? %>
                              <% target_path = post.topic.respond_to?(:forum) && post.topic.forum.present? ? forum_topic_path(post.topic.forum, post.topic) : (defined?(topic_path) ? topic_path(post.topic) : '#') rescue '#' %>
                              <%= link_to '表示', target_path,
                                          class: 'btn btn-sm btn-outline-primary',
                                          aria: { label: "投稿のあるトピックを表示" } %>
                            <% else %>
                              <span class="text-muted">—</span>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% else %>
                <div class="p-3 text-muted">まだ投稿はありません。</div>
              <% end %>
            </div>
          </div>

          <!-- レビュー一覧 -->
          <div class="card mb-3">
            <div class="card-header">レビュー（最近 <%= @reviews.size %> 件）</div>
            <div class="card-body p-0">
              <% if @reviews.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>プラットフォーム</th>
                        <th>ジャンル</th>
                        <th>タイトル</th>
                        <th class="text-nowrap">プレイ時間</th>
                        <th class="text-end"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @reviews.each do |review| %>
                        <tr>
                          <td class="text-nowrap"><%= review.created_at.strftime('%Y/%m/%d') %></td>
                          <td><%= h(review.platform&.name.presence || '—') %></td>
                          <td><%= h(review.genre&.name.presence || '—') %></td>
                          <td><%= h(review.title) %></td>
                          <td class="text-nowrap"><%= h(review.play_time.presence || '—') %></td>
                          <td class="text-end text-nowrap">
                            <% review_path_target = (defined?(review_path) ? review_path(review) : '#') rescue '#' %>
                            <%= link_to '表示', review_path_target,
                                        class: 'btn btn-sm btn-outline-primary',
                                        aria: { label: "#{review.title} のレビューを表示" } %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% else %>
                <div class="p-3 text-muted">まだレビューはありません。</div>
              <% end %>
            </div>
          </div>

          <!-- レビューへのコメント一覧（テーブル形式） -->
          <div class="card mb-3">
            <div class="card-header">レビューへのコメント（最近 <%= @review_comments.size %> 件）</div>
            <div class="card-body p-0">
              <% if @review_comments.any? %>
                <div class="table-responsive">
                  <table class="table mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>投稿日</th>
                        <th>コメントしたレビュー</th>
                        <th>コメント内容</th>
                        <th class="text-end" style="width:120px;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @review_comments.each do |rc| %>
                        <tr>
                          <td class="text-nowrap"><%= rc.created_at.strftime('%Y/%m/%d') %></td>
                          <td>
                            <%= link_to h(rc.review.title), review_path(rc.review), class: 'text-decoration-none' %>
                            <div class="small text-muted">
                              <%= h(rc.review.platform&.name.presence || '未設定') %> /
                              <%= h(rc.review.genre&.name.presence || '未設定') %>
                            </div>
                          </td>
                          <td><%= h(truncate(rc.comment.to_s, length: 120)) %></td>
                          <td class="text-end text-nowrap">
                            <%= link_to '表示', review_path(rc.review), class: 'btn btn-sm btn-outline-primary', aria: { label: "#{rc.review.title} のレビューを表示" } %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% else %>
                <div class="p-3 text-muted">レビューに対するコメントはまだありません。</div>
              <% end %>
            </div>
          </div>

        </div>

        <div class="mt-3">
          <%= link_to 'トップページへ', root_path, class: 'btn btn-link' %>
        </div>
      </div>
    </div>
  </div>
</div>