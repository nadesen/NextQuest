<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-md-10">

      <!-- トピックカード -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="card-title"><%= @topic.title %></h2>
          <div class="mb-2 text-muted small">
            フォーラム:
            <%= link_to @forum.title, forum_topics_path(@forum) %>
            &nbsp;・&nbsp;

            作成者:
            <% creator = @topic.respond_to?(:creator) ? @topic.creator : @topic.user %>
            <% if creator.present? %>
              <% display_name = creator.nickname.presence || creator.name.presence || 'ユーザー' %>
              <%= link_to h(display_name), user_path(creator), class: 'fw-medium text-decoration-none' %>
            <% else %>
              <span class="text-muted">匿名</span>
            <% end %>
            &nbsp;・&nbsp;

            <%= @topic.created_at.in_time_zone(Time.zone).strftime('%Y/%m/%d') %>
          </div>

          <% if @topic.description.present? %>
            <p class="card-text"><%= simple_format(@topic.description) %></p>
          <% end %>

          <% can_edit = user_signed_in? && (
                (creator.present? && creator == current_user) ||
                (@topic.respond_to?(:creator_id) && @topic.creator_id == current_user&.id) ||
                (@topic.respond_to?(:user_id) && @topic.user_id == current_user&.id)
              ) %>

          <% if can_edit %>
            <div class="mt-3">
              <div class="d-flex gap-2">
                <%= link_to '編集', edit_forum_topic_path(@forum, @topic), class: 'btn btn-sm btn-outline-primary' %>
                <%= form_with url: forum_topic_path(@forum, @topic), method: :delete, local: true, html: { class: 'd-inline' } do %>
                  <%= submit_tag '削除', data: { confirm: 'トピックを削除してもよろしいですか？' }, class: 'btn btn-sm btn-danger' %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 投稿一覧 -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">投稿</h4>
          <div class="topic-posts-counter small text-muted">
            <%= render 'public/posts/counter', topic: @topic %>
          </div>
        </div>

        <div class="topic-posts-index mb-3">
          <%= render 'public/posts/index', topic: @topic, posts: (@posts || @topic.posts.order(created_at: :asc)) %>
        </div>

        <% if defined?(Kaminari) && @posts.respond_to?(:total_pages) %>
          <div class="mt-3">
            <%= paginate @posts %>
          </div>
        <% end %>
      </div>

      <!-- 新規投稿フォーム -->
      <div class="mb-5">
        <h4 class="mb-3">返信・投稿する</h4>

        <% if user_signed_in? %>
          <%= render 'public/posts/form', forum: @forum, topic: @topic, post: (@post || Post.new) %>
        <% else %>
          <div class="alert alert-info">
            投稿するには <%= link_to 'ログイン', new_user_session_path %> が必要です。
          </div>
        <% end %>
      </div>

      <div class="d-flex justify-content-between">
        <%= link_to 'トピック一覧に戻る', forum_topics_path(@forum), class: 'btn btn-outline-secondary' %>
        <%= link_to 'フォーラム一覧に戻る', forums_path, class: 'btn btn-link' %>
      </div>

    </div>
  </div>
</div>